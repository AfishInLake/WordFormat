# 技术架构

本文档详细说明 WordFormat 项目的技术架构和实现原理，帮助您理解项目的设计思路和核心组件。

## 整体架构

WordFormat 采用模块化设计，将文档处理流程拆分为多个独立的组件，每个组件负责特定的功能。整体架构分为以下几个层次：

1. **用户交互层**：命令行界面、Python API、Web API
2. **核心处理层**：文档结构解析、格式检查、格式修正
3. **模型层**：ONNX 模型推理
4. **规则层**：基于配置的格式规则引擎
5. **存储层**：配置文件管理、JSON 结构文件管理
6. **工具层**：文档操作、格式转换、日志管理

## 核心组件

### 1. 文档结构解析

#### 实现原理
- **ONNX 模型推理**：使用预训练的 ONNX 模型对文档段落进行分类，识别标题、摘要、正文等不同类型
- **批量处理**：采用批量推理方式，提高处理速度
- **后处理逻辑**：对模型输出进行后处理，包括置信度过滤、特殊段落处理等

#### 核心代码
- `src/wordformat/base.py`：DocxBase 类，负责文档解析和模型推理
- `src/wordformat/agent/onnx_infer.py`：ONNX 模型推理实现
- `src/wordformat/set_tag.py`：生成文档结构 JSON 文件

### 2. 格式检查与修正

#### 实现原理
- **规则引擎**：基于配置文件定义的规则，对文档格式进行检查
- **差异比较**：将文档实际格式与预期格式进行比较，生成差异报告
- **自动修正**：根据差异报告自动修正格式问题
- **批注生成**：在格式违规位置生成 Word 批注，标注问题类型和修正建议

#### 核心代码
- `src/wordformat/style/check_format.py`：格式检查实现
- `src/wordformat/style/set_some.py`：格式修正实现
- `src/wordformat/set_style.py`：自动格式化文档

### 3. 文档结构管理

#### 实现原理
- **树形结构**：使用树形结构表示文档的层次关系
- **节点工厂**：根据段落类型创建不同的节点实例
- **文档构建器**：从 JSON 文件构建文档结构树
- **节点操作**：提供节点的添加、删除、修改等操作

#### 核心代码
- `src/wordformat/word_structure/tree_builder.py`：构建文档结构树
- `src/wordformat/word_structure/node_factory.py`：创建不同类型的节点
- `src/wordformat/word_structure/document_builder.py`：从 JSON 构建文档结构
- `src/wordformat/tree.py`：树形结构实现

### 4. 配置系统

#### 实现原理
- **YAML 配置**：使用 YAML 文件定义格式规范
- **配置验证**：使用 Pydantic 对配置文件进行验证
- **配置继承**：支持配置文件的继承和覆盖，减少重复配置
- **配置加载**：动态加载配置文件，支持运行时配置变更

#### 核心代码
- `src/wordformat/config/config.py`：配置文件加载和管理
- `src/wordformat/config/datamodel.py`：配置数据模型定义

### 5. 命令行界面

#### 实现原理
- **Click 框架**：使用 Click 库实现命令行界面
- **子命令系统**：支持多个子命令，如 generate-json、check-format、apply-format
- **参数解析**：自动解析命令行参数，支持短选项和长选项
- **帮助信息**：自动生成命令行帮助信息

#### 核心代码
- `src/wordformat/cli.py`：命令行界面实现

### 6. API 服务

#### 实现原理
- **FastAPI 框架**：使用 FastAPI 实现 Web API
- **RESTful 设计**：采用 RESTful 风格设计 API 端点
- **自动文档**：自动生成 API 文档，可通过 /docs 访问
- **异步处理**：支持异步请求处理，提高并发性能

#### 核心代码
- `start_api.py`：API 服务启动脚本

## 数据流程

### 1. 生成文档结构 JSON

1. **输入**：Word 文档路径、配置文件路径
2. **处理**：
   - 读取 Word 文档
   - 提取段落文本
   - 使用 ONNX 模型批量推理段落类型
   - 生成结构化 JSON 数据
3. **输出**：JSON 结构文件

### 2. 执行格式校验

1. **输入**：Word 文档路径、JSON 结构文件路径、配置文件路径
2. **处理**：
   - 读取 Word 文档
   - 加载 JSON 结构文件
   - 构建文档结构树
   - 遍历树节点，执行格式检查
   - 在违规位置添加批注
3. **输出**：带批注的 Word 文档

### 3. 执行格式格式化

1. **输入**：Word 文档路径、JSON 结构文件路径、配置文件路径
2. **处理**：
   - 读取 Word 文档
   - 加载 JSON 结构文件
   - 构建文档结构树
   - 遍历树节点，执行格式修正
3. **输出**：格式化后的 Word 文档

## 技术栈

### 核心依赖

| 依赖项 | 版本/要求 | 用途 |
|-------|-----------|------|
| Python | 3.11+ | 运行环境 |
| python-docx | 最新版 | Word 文档操作 |
| PyYAML | 最新版 | 配置文件解析 |
| Pydantic | 最新版 | 数据验证 |
| Click | 最新版 | 命令行界面 |
| FastAPI | 最新版 | Web API |
| ONNX Runtime | 最新版 | 模型推理 |
| Loguru | 最新版 | 日志管理 |

### 开发工具

| 工具 | 用途 |
|------|------|
| pytest | 单元测试 |
| flake8 | 代码风格检查 |
| mypy | 类型注解检查 |
| uv | 依赖管理 |
| Make | 构建自动化 |

## 性能优化

### 1. 批量处理

- **批量推理**：将多个段落批量输入模型，减少推理次数
- **批量文件操作**：批量读写文件，减少 I/O 操作次数
- **内存优化**：合理管理内存使用，避免内存泄漏

### 2. 缓存机制

- **配置缓存**：缓存配置文件解析结果，避免重复解析
- **模型缓存**：缓存模型加载结果，避免重复加载
- **文档缓存**：缓存文档解析结果，避免重复解析

### 3. 并行处理

- **异步 API**：使用异步方式处理 API 请求
- **并行测试**：使用 pytest-xdist 并行运行测试

## 扩展性设计

### 1. 插件系统

- **格式检查插件**：允许添加自定义格式检查规则
- **模型插件**：允许集成不同的模型进行文档结构解析
- **输出格式插件**：允许输出不同格式的结果报告

### 2. 配置系统

- **配置模板**：支持不同类型的文档格式模板
- **配置继承**：支持配置的继承和覆盖，减少重复配置
- **配置验证**：自动验证配置的正确性，提高配置可靠性

### 3. 多语言支持

- **中英文混合**：支持中英文混合文档的处理
- **多语言配置**：支持不同语言的格式规则配置
- **国际化**：预留国际化支持，可扩展到其他语言

## 安全性考虑

### 1. 输入验证

- **文件路径验证**：验证输入文件路径的合法性
- **配置验证**：验证配置文件的正确性和安全性
- **参数验证**：验证命令行参数和 API 参数的合法性

### 2. 错误处理

- **异常捕获**：捕获并处理所有异常，避免程序崩溃
- **错误日志**：记录详细的错误信息，便于排查问题
- **用户友好的错误提示**：向用户提供清晰、友好的错误提示

### 3. 资源管理

- **文件锁定**：避免多个进程同时修改同一文件
- **内存管理**：合理管理内存使用，避免内存泄漏
- **磁盘空间**：检查磁盘空间是否充足，避免磁盘空间不足导致的问题

## 未来发展

### 1. 技术升级

- **模型优化**：使用更先进的模型，提高文档结构识别准确率
- **性能优化**：进一步优化处理速度和内存使用
- **架构升级**：采用更现代化的架构设计，提高系统可维护性

### 2. 功能扩展

- **多格式支持**：支持更多文档格式，如 Markdown、LaTeX 等
- **云服务**：提供云服务，支持在线文档处理
- **协作功能**：支持多人协作处理文档格式

### 3. 生态系统

- **模板库**：建立丰富的格式模板库，覆盖更多学校和期刊
- **插件市场**：建立插件市场，允许用户分享和使用插件
- **社区建设**：建立活跃的社区，促进项目发展

## 总结

WordFormat 采用模块化、可扩展的设计，将文档处理流程拆分为多个独立的组件，每个组件负责特定的功能。通过 ONNX 模型推理和规则引擎相结合的方式，实现了文档结构的智能解析和格式的自动检查与修正。

项目的技术架构设计考虑了性能、扩展性和安全性，为未来的功能扩展和技术升级预留了空间。通过持续的优化和改进，WordFormat 有望成为学术论文格式处理的标准工具，为广大学生和研究人员提供便捷、高效的文档格式处理服务。
